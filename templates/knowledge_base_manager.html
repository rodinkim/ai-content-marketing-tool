<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지식 베이스 관리 - AI 콘텐츠 생성기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* 기존 style.css 외에 이 페이지에 필요한 추가 스타일 */
        .main-wrapper {
            max-width: 960px;
            margin: auto;
            padding: 40px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            flex-grow: 1;
        }
        /* 관리자 UI를 위한 추가 스타일 */
        .admin-content-area {
            display: flex; /* 사용자 목록과 파일 목록을 가로로 정렬 */
            gap: 20px; /* 간격 */
            margin-top: 20px;
        }
        .user-list-container, .file-list-container {
            flex: 1; /* 두 컨테이너가 동일한 너비를 가지도록 */
            background-color: var(--light-bg); /* 배경색 지정 */
            border-radius: 8px;
            padding: 20px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* 내부 그림자 */
            overflow-y: auto; /* 내용이 넘칠 경우 스크롤 */
            max-height: 500px; /* 최대 높이 설정 */
        }
        .user-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer; /* 클릭 가능한 항목에 커서 변경 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .user-item:hover {
            background-color: var(--hover-bg); /* 호버 효과 */
        }
        .user-item-name {
            font-weight: 500;
        }
        /* -- 파일명과 버튼 레이아웃 수정 -- */
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            /* 파일명과 버튼이 서로 공간을 침범하지 않도록 설정 */
            /* word-break: break-all; - 긴 파일명 자체의 줄바꿈은 허용하되, 버튼 영역은 침범하지 않도록 */
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-item-name {
            flex-grow: 1; /* 남은 공간을 채우되, 줄어들 수도 있도록 (아래 min-width와 함께) */
            font-weight: 500;
            margin-right: 15px; /* 파일명과 버튼 사이에 여백 추가 */
            overflow: hidden; /* 넘치는 텍스트 숨김 */
            text-overflow: ellipsis; /* 넘치는 텍스트 ...으로 표시 */
            white-space: nowrap; /* 파일명은 한 줄로 표시하되, 넘치면 ...으로 */
            min-width: 0; /* flex item에서 내용이 넘칠 때 줄바꿈이 아닌 생략되도록 허용 */
        }
        .file-item-actions {
            flex-shrink: 0; /* <-- 버튼 그룹이 공간이 부족해도 줄어들지 않도록 */
            display: flex; /* 버튼을 가로로 정렬 */
            align-items: center;
        }
        .file-item-actions button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.875rem;
            white-space: nowrap; /* <-- 텍스트 줄바꿈 방지 */
            min-width: 60px; /* <-- 버튼의 최소 너비 설정 (텍스트가 충분히 들어갈 만큼) */
            text-align: center; /* 텍스트 가운데 정렬 */
        }
        /* -- 수정 끝 -- */
        .section-header {
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="{{ url_for('auth_routes.index') }}">AI 콘텐츠</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        {% if current_user.is_authenticated %}
                            <li class="nav-item d-flex align-items-center me-2">
                                <span class="nav-link text-muted pe-0">환영합니다,</span>
                                <span class="nav-link fw-bold text-dark ps-1">{{ current_user.username }}님!</span>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('content_routes.get_history_page') }}">내 기록</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('knowledge_base_routes.manage_knowledge_base') }}">지식 베이스</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link btn btn-danger text-white" href="{{ url_for('auth_routes.logout') }}">로그아웃</a>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('auth_routes.register') }}">회원가입</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link btn btn-primary text-white" href="{{ url_for('auth_routes.login') }}">로그인</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>

        <h2 class="mb-4 text-center">지식 베이스 관리</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {# URL에서 콘텐츠 추가 섹션 #}
        <h4 class="section-header">URL에서 지식 추가</h4>
        <div class="card p-3 mb-4">
            <form id="addUrlForm">
                <div class="mb-3">
                    <label for="urlInput" class="form-label">기사 URL 입력:</label>
                    <input type="url" class="form-control" id="urlInput" name="url" placeholder="예: https://news.example.com/article-title" required>
                    <small class="form-text text-muted">기사 본문이 잘 추출되는 URL을 입력해주세요.</small>
                </div>
                <button type="submit" class="btn btn-primary w-100" id="addUrlBtn">
                    URL에서 지식 추가
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                </button>
            </form>
        </div>

        {# 관리자 전용: 모든 사용자 목록 및 파일 #}
        {% if is_admin %}
        <h4 class="section-header">모든 사용자 지식 베이스 관리</h4>
        <div class="admin-content-area">
            <div class="card p-3 user-list-container">
                <h5 class="mb-3">사용자 목록</h5>
                <div id="userList">
                    <p class="text-muted text-center" id="noUsersMessage">사용자가 없습니다.</p>
                </div>
            </div>
            <div class="card p-3 file-list-container">
                <h5 class="mb-3" id="adminFileListHeader">선택된 사용자의 파일</h5>
                <div id="adminFileList">
                    <p class="text-muted text-center" id="noAdminFilesMessage">사용자를 선택하여 파일을 확인하세요.</p>
                </div>
                <button class="btn btn-danger mt-3" id="adminClearUserKbBtn" style="display: none;">선택된 사용자의 모든 파일 삭제</button>
            </div>
        </div>
        {% else %}
        {# 일반 사용자: 자신의 지식 베이스 파일 목록 #}
        <h4 class="section-header">나의 지식 베이스 파일 목록</h4>
        <div class="card p-3">
            <div id="fileList">
                <p class="text-muted text-center" id="noFilesMessage">지식 베이스에 파일이 없습니다.</p>
            </div>
            <button class="btn btn-danger mt-3" id="clearAllKbBtn" style="display: none;">모든 지식 베이스 파일 삭제</button>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {# 지식 베이스 관리 기능을 위한 JavaScript 파일 #}
    <script>
        // Flask URL을 JavaScript 변수로 정의 (knowledge_base_manager.js 로드 전에 정의)
        // 일반 사용자용 API URL
        const flaskKnowledgeBaseFilesUrl = "{{ url_for('knowledge_base_routes.list_knowledge_base_files') }}"; 
        const flaskDeleteFileUrlBase = "{{ url_for('knowledge_base_routes.delete_knowledge_base_file', filename='') }}"; 
        const flaskClearAllKbUrl = "{{ url_for('knowledge_base_routes.clear_all_knowledge_base_files') }}"; 
        
        // 관리자용 API URL (is_admin 변수 활용)
        const isAdminUser = {{ is_admin | tojson }};
        const flaskUsersListUrl = "{{ url_for('knowledge_base_routes.list_all_users_for_admin') }}";
        
        // flaskAdminTargetFilesUrlBase의 정의.
        const flaskAdminTargetFilesUrlBase = "{{ url_for('knowledge_base_routes.list_knowledge_base_files', target_username='DUMMY') }}".replace('DUMMY', ''); 
        const flaskAdminTargetDeleteUrlBase = "{{ url_for('knowledge_base_routes.delete_knowledge_base_file', target_username='DUMMY', filename='DUMMY_FILE') }}".split('/DUMMY/DUMMY_FILE')[0] + '/';
        const flaskAdminTargetClearAllUrlBase = "{{ url_for('knowledge_base_routes.clear_all_knowledge_base_files', target_username='DUMMY') }}".replace('DUMMY', '');

        // 공통 API URL
        const flaskAddUrlUrl = "{{ url_for('knowledge_base_routes.add_knowledge_base_from_url') }}";


        // 로그인/로그아웃/회원가입/인덱스 URL (네비게이션 바에서 사용)
        const flaskAuthIndexUrl = "{{ url_for('auth_routes.index') }}";
        const flaskContentHistoryUrl = "{{ url_for('content_routes.get_history_page') }}";
        const flaskAuthLogoutUrl = "{{ url_for('auth_routes.logout') }}";
        const flaskAuthRegisterUrl = "{{ url_for('auth_routes.register') }}";
        const flaskAuthLoginUrl = "{{ url_for('auth_routes.login') }}";
        const flaskKnowledgeBaseManageUrl = "{{ url_for('knowledge_base_routes.manage_knowledge_base') }}";
    </script>
    <script src="{{ url_for('static', filename='js/knowledge_base_manager.js') }}"></script>
</body>
</html>